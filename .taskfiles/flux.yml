---
version: "3"

tasks:
  sync:
    desc: Sync flux-system with the Git Repository
    cmds:
      - flux reconcile source git flux-system
    silent: true

  create:
    desc: Create Flux setup
    cmds:
      - kubectl create namespace flux-system
      - cat ~/.config/sops/age/keys.txt | kubectl --kubeconfig=./provision/kubeconfig -n flux-system create secret generic sops-age --from-file=age.agekey=/dev/stdin
      - kubectl apply -k ./cluster/base/flux-system
      - kubectl apply -k ./cluster/base/flux-system

  taints:
    desc: Apply labels and taints
    cmds:
      - for i in {0..2}; do kubectl label nodes k8s-worker-$i node-role.kubernetes.io/worker=true; done
      - for i in {0..2}; do kubectl taint nodes k8s-master-$i node-role.kubernetes.io/master=:NoSchedule; done
